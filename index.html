<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cascading Location Widget</title>
    <!-- JotForm Custom Widget Library -->
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
    <style>
        body {
            font-family: 'Verdana', sans-serif;
            font-size: 14px;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        select, input[type="text"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 100%;
            font-size: 14px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>

    <div class="container" id="widget-container">
        
        <!-- STATE SECTION -->
        <div class="form-group">
            <label for="stateDropdown">State</label>
            <select id="stateDropdown">
                <option value="">Select State...</option>
            </select>
            <input type="text" id="stateInput" class="hidden" placeholder="Enter State">
        </div>

        <!-- DISTRICT SECTION -->
        <div class="form-group" id="districtGroup">
            <label for="districtDropdown">District</label>
            <select id="districtDropdown" disabled>
                <option value="">Select District...</option>
            </select>
            <input type="text" id="districtInput" class="hidden" placeholder="Enter District">
        </div>

        <!-- SITE SECTION -->
        <div class="form-group" id="siteGroup">
            <label for="siteDropdown">Site</label>
            <select id="siteDropdown" disabled>
                <option value="">Select Site...</option>
            </select>
            <input type="text" id="siteInput" class="hidden" placeholder="Enter Site">
        </div>

    </div>

    <script type="text/javascript">
        // --- MOCK FOR TESTING ---
        if (typeof JFCustomWidget === 'undefined') {
            window.JFCustomWidget = {
                subscribe: function(e, c) { if(e==='ready') setTimeout(c, 100); },
                requestFrameResize: function() {},
                sendSubmit: function(d) { console.log("Submit:", d); },
                sendData: function(d) { console.log("Data Sent:", d); }
            };
        }

        // --- 1. DATA CONFIGURATION ---
        const data = {
            "Arizona": {
                "Amphi": ["Copper Creek Elementary", "Canyon del Oro High", "Ironwood Ridge"],
                "Tucson Unified": ["Tucson High", "Catalina High", "Rincon High"]
            },
            "California": {
                "Los Angeles Unified": ["Hollywood High", "Venice High"],
                "San Diego Unified": ["La Jolla High", "Madison High"]
            }
        };

        // --- 2. DOM ELEMENTS ---
        const stateSelect = document.getElementById('stateDropdown');
        const districtSelect = document.getElementById('districtDropdown');
        const siteSelect = document.getElementById('siteDropdown');
        const stateInput = document.getElementById('stateInput');
        const districtInput = document.getElementById('districtInput');
        const siteInput = document.getElementById('siteInput');

        // --- 3. INITIALIZATION ---
        (function() {
            Object.keys(data).forEach(state => {
                let option = document.createElement('option');
                option.value = state;
                option.text = state;
                stateSelect.add(option);
            });
            let otherOption = document.createElement('option');
            otherOption.value = "Other";
            otherOption.text = "Other";
            stateSelect.add(otherOption);

            JFCustomWidget.subscribe("ready", function(){
                JFCustomWidget.requestFrameResize({height: document.body.offsetHeight});
            });
        })();

        // --- 4. CORE LOGIC ---

        function handleStateChange() {
            const val = stateSelect.value;
            resetDistrict();
            resetSite();

            if (val === "Other") {
                stateInput.classList.remove('hidden');
                districtSelect.classList.add('hidden');
                districtInput.classList.remove('hidden');
                siteSelect.classList.add('hidden');
                siteInput.classList.remove('hidden');
            } else if (val) {
                stateInput.classList.add('hidden');
                populateDistricts(val);
                districtSelect.classList.remove('hidden');
                districtInput.classList.add('hidden');
                districtSelect.disabled = false;
            } else {
                stateInput.classList.add('hidden');
                districtSelect.disabled = true;
            }
            resizeAndBroadcast();
        }

        function handleDistrictChange() {
            const stateVal = stateSelect.value;
            const distVal = districtSelect.value;
            resetSite();

            if (distVal === "Other") {
                districtInput.classList.remove('hidden');
                siteSelect.classList.add('hidden');
                siteInput.classList.remove('hidden');
            } else if (distVal) {
                districtInput.classList.add('hidden');
                populateSites(stateVal, distVal);
                siteSelect.classList.remove('hidden');
                siteInput.classList.add('hidden');
                siteSelect.disabled = false;
            } else {
                districtInput.classList.add('hidden');
                siteSelect.disabled = true;
            }
            resizeAndBroadcast();
        }

        function handleSiteChange() {
            if (siteSelect.value === "Other") {
                siteInput.classList.remove('hidden');
            } else {
                siteInput.classList.add('hidden');
            }
            resizeAndBroadcast();
        }

        // --- 5. EVENT LISTENERS ---
        // Trigger updates on Dropdown changes AND Text Input changes
        stateSelect.addEventListener('change', handleStateChange);
        districtSelect.addEventListener('change', handleDistrictChange);
        siteSelect.addEventListener('change', handleSiteChange);

        // Listen for typing in the "Other" boxes
        stateInput.addEventListener('input', resizeAndBroadcast);
        districtInput.addEventListener('input', resizeAndBroadcast);
        siteInput.addEventListener('input', resizeAndBroadcast);


        // --- 6. DATA TRANSMISSION ---

        function calculateCurrentValue() {
            var result = {};
            
            // Determine Final State
            if (stateSelect.value === "Other") result.state = stateInput.value || "Not Provided";
            else result.state = stateSelect.value;

            // Determine Final District
            if (stateSelect.value === "Other" || districtSelect.value === "Other") result.district = districtInput.value || "Not Provided";
            else result.district = districtSelect.value;

            // Determine Final Site
            if (stateSelect.value === "Other" || districtSelect.value === "Other" || siteSelect.value === "Other") result.site = siteInput.value || "Not Provided";
            else result.site = siteSelect.value;

            return {
                valid: !!(result.state && result.district && result.site),
                value: "State: " + result.state + ", District: " + result.district + ", Site: " + result.site
            };
        }

        function resizeAndBroadcast() {
            JFCustomWidget.requestFrameResize({height: document.body.offsetHeight});
            
            // THIS is the missing link. We send data to JotForm immediately on every change.
            var data = calculateCurrentValue();
            JFCustomWidget.sendData({ value: data.value });
        }

        JFCustomWidget.subscribe("submit", function() {
            var data = calculateCurrentValue();
            JFCustomWidget.sendSubmit(data);
        });

        // --- 7. HELPER FUNCTIONS ---

        function populateDistricts(state) {
            districtSelect.innerHTML = '<option value="">Select District...</option>';
            if (data[state]) {
                Object.keys(data[state]).forEach(dist => {
                    let option = document.createElement('option');
                    option.value = dist;
                    option.text = dist;
                    districtSelect.add(option);
                });
                let other = document.createElement('option');
                other.value = "Other";
                other.text = "Other";
                districtSelect.add(other);
            }
        }

        function populateSites(state, district) {
            siteSelect.innerHTML = '<option value="">Select Site...</option>';
            if (data[state] && data[state][district]) {
                data[state][district].forEach(site => {
                    let option = document.createElement('option');
                    option.value = site;
                    option.text = site;
                    siteSelect.add(option);
                });
                let other = document.createElement('option');
                other.value = "Other";
                other.text = "Other";
                siteSelect.add(other);
            }
        }

        function resetDistrict() {
            districtSelect.selectedIndex = 0;
            districtSelect.disabled = true;
            districtSelect.classList.remove('hidden');
            districtInput.classList.add('hidden');
            districtInput.value = "";
        }

        function resetSite() {
            siteSelect.selectedIndex = 0;
            siteSelect.disabled = true;
            siteSelect.classList.remove('hidden');
            siteInput.classList.add('hidden');
            siteInput.value = "";
        }

    </script>
</body>
</html>
